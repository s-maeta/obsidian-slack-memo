# Obsidian Slack 同期プラグイン アーキテクチャ設計

## システム概要

Obsidian Slack 同期プラグインは、Slack API を通じてメッセージを取得し、Obsidian
のローカルファイルシステムに保存するプラグインです。Obsidian のプラグインアーキ
テクチャに準拠し、TypeScript で実装されます。

## アーキテクチャパターン

- **パターン**: Event-Driven Architecture + Plugin Architecture
- **理由**:
  - Obsidian のプラグインシステムがイベント駆動型であるため
  - Slack API からの非同期データ取得に適している
  - ユーザーアクションと自動同期の両方に対応可能

## コンポーネント構成

### プラグインコア

- **言語**: TypeScript
- **フレームワーク**: Obsidian Plugin API
- **主要責務**:
  - プラグインのライフサイクル管理
  - 設定の読み込み・保存
  - UI コンポーネントの初期化

### Slack API 連携層

- **認証方式**: OAuth 2.0 (Slack App)
- **通信方式**: HTTPS REST API
- **主要責務**:
  - Slack API への認証
  - メッセージの取得
  - レート制限の管理

### データ処理層

- **主要責務**:
  - Slack メッセージの解析
  - Markdown 形式への変換
  - チャンネル別の振り分け処理
  - 重複チェック

### ストレージ層

- **設定ファイル**: Obsidian Plugin Data API
- **ファイルシステム**: Obsidian Vault (ローカル)
- **主要責務**:
  - 設定情報の永続化（data.json）
  - 同期状態の管理
  - メッセージの Markdown ファイル保存

### UI 層

- **フレームワーク**: Obsidian UI Components
- **主要機能**:
  - 設定画面
  - 同期状況表示
  - エラー通知

## 技術スタック

### 開発環境

- TypeScript 5.x
- Node.js 18.x
- npm/yarn
- ESBuild (バンドラー)

### 依存ライブラリ

- Obsidian API
- Slack Web API Client
- date-fns (日付処理)

### 開発ツール

- ESLint (コード品質)
- Prettier (コードフォーマット)
- Jest (ユニットテスト)

## セキュリティ設計

### 認証情報の管理

- Slack OAuth トークンは Obsidian の Plugin Data API で安全に保存
- プラグイン専用の設定ファイル
  （.obsidian/plugins/obsidian-slack-sync/data.json）
- トークンのリフレッシュ機構を実装

### 通信のセキュリティ

- すべての Slack API 通信は HTTPS
- API キーの漏洩防止のため、開発時も環境変数を使用

## パフォーマンス設計

### 非同期処理

- Slack API へのリクエストは非ブロッキング
- バックグラウンドでの定期同期
- プログレッシブレンダリング

### キャッシュ戦略

- チャンネルごとの最終同期時刻を保存し、差分同期を実現
- Slack API の`oldest`パラメータで効率的に新規メッセージのみ取得
- API 応答の一時キャッシュ（5 分間）

### バッチ処理

- 大量メッセージは 100 件単位でバッチ処理
- UI の応答性を保つため、処理を分割

## エラーハンドリング

### リトライ戦略

- ネットワークエラー: 指数バックオフでリトライ（最大 3 回）
- レート制限: Retry-After ヘッダーに従って待機
- 認証エラー: ユーザーに再認証を促す

### ログ記録

- エラーログは Obsidian のコンソールに出力
- 重要なエラーはユーザーに通知

## 拡張性

### プラグインアーキテクチャ

- 新しいチャンネルタイプの追加が容易
- カスタムフォーマッターの追加可能
- フィルター機能の拡張ポイント

### 将来の拡張計画

- 他のメッセージングサービスへの対応
- AI 連携による自動タグ付け
- 双方向同期の実装
