# TASK-401: 自動同期スケジューラー - テストケース設計

## テスト概要

自動同期スケジューラーの品質を保証するため、包括的なテストケースを設計します。単体テスト、統合テスト、エラーテスト、パフォーマンステストを含みます。

## テスト分類

### 1. 単体テスト（Unit Tests）

#### AutoSyncScheduler クラス

##### TC-AS-001: コンストラクタとプロパティ
- **目的**: インスタンス生成と初期状態の確認
- **テストケース**:
  - 正常なパラメータでインスタンス生成
  - デフォルト設定値の確認
  - 初期状態（isRunning: false）の確認

##### TC-AS-002: start() メソッド
- **目的**: スケジューラー開始機能の確認
- **テストケース**:
  - 初回start()でisRunning()がtrueになる
  - 初回同期が設定に応じて実行される
  - setIntervalが正しい間隔で設定される
  - 既に開始済みの場合は何もしない

##### TC-AS-003: stop() メソッド
- **目的**: スケジューラー停止機能の確認
- **テストケース**:
  - stop()でisRunning()がfalseになる
  - setIntervalがclearIntervalされる
  - 停止後は自動同期が実行されない
  - 既に停止済みの場合は何もしない

##### TC-AS-004: restart() メソッド
- **目的**: スケジューラー再起動機能の確認
- **テストケース**:
  - 実行中のスケジューラーが一旦停止される
  - 新しい設定で再開される
  - 再起動中も状態が正しく管理される

##### TC-AS-005: updateInterval() メソッド
- **目的**: 同期間隔の動的更新確認
- **テストケース**:
  - 新しい間隔でスケジューラーが再設定される
  - 現在実行中の同期は中断されない
  - 無効な間隔（0以下）は拒否される

##### TC-AS-006: isRunning() メソッド
- **目的**: 実行状態の正確な取得確認
- **テストケース**:
  - start()後にtrueを返す
  - stop()後にfalseを返す
  - 内部状態と一致した値を返す

##### TC-AS-007: getLastSyncTime() メソッド
- **目的**: 最終同期時刻の取得確認
- **テストケース**:
  - 初期状態でnullを返す
  - 同期完了後に正確な時刻を返す
  - 複数回同期後は最新時刻を返す

##### TC-AS-008: getNextSyncTime() メソッド
- **目的**: 次回同期時刻の予測確認
- **テストケース**:
  - 実行中は次回同期予定時刻を返す
  - 停止中はnullを返す
  - 間隔変更後は更新された時刻を返す

##### TC-AS-009: forceSyncNow() メソッド
- **目的**: 即座同期実行機能の確認
- **テストケース**:
  - 即座に同期処理が開始される
  - Promise完了まで待機可能
  - 同期中の重複実行を防止する

##### TC-AS-010: updateSettings() メソッド
- **目的**: 設定動的更新機能の確認
- **テストケース**:
  - 新しい設定が即座に反映される
  - 自動同期有効/無効が適用される
  - 不正な設定は拒否される

### 2. 同期競合防止テスト

##### TC-CF-001: 重複実行防止
- **目的**: 同期処理の重複実行を防止
- **テストケース**:
  - 同期中の新しい自動同期を阻止
  - 手動同期中の自動同期を延期
  - 複数の自動同期が並行しない

##### TC-CF-002: 最小間隔制限
- **目的**: 短すぎる間隔での実行を防止
- **テストケース**:
  - 1分未満の連続実行を阻止
  - 前回同期から最小時間経過を確認
  - 強制同期は最小間隔制限を無視

##### TC-CF-003: 同期状態管理
- **目的**: 同期状態の正確な管理
- **テストケース**:
  - 同期開始時にフラグが立つ
  - 同期完了時にフラグがクリアされる
  - エラー時もフラグが適切にクリア

### 3. エラーハンドリングテスト

##### TC-EH-001: ネットワークエラー対応
- **目的**: ネットワーク障害時の動作確認
- **テストケース**:
  - API呼び出し失敗時のリトライ
  - 最大3回のリトライ実行
  - リトライ失敗後の適切なエラー通知

##### TC-EH-002: リトライ機構
- **目的**: 指数バックオフによるリトライ
- **テストケース**:
  - 1回目：1秒後リトライ
  - 2回目：2秒後リトライ  
  - 3回目：4秒後リトライ
  - 4回目以降はエラー通知

##### TC-EH-003: タイムアウト処理
- **目的**: 長時間実行の検出と対処
- **テストケース**:
  - 30秒を超える同期のタイムアウト
  - タイムアウト後の状態リセット
  - ユーザーへのタイムアウト通知

##### TC-EH-004: 設定エラー対応
- **目的**: 不正設定時の適切な処理
- **テストケース**:
  - 空のSlackトークン検出
  - 不正な同期間隔の拒否
  - デフォルトチャンネル未設定の警告

### 4. 設定連携テスト

##### TC-SC-001: 設定反映
- **目的**: プラグイン設定との連携確認
- **テストケース**:
  - autoSyncフラグのON/OFF反映
  - syncInterval値の動的更新
  - 設定変更の即時適用

##### TC-SC-002: 設定検証
- **目的**: 設定値の妥当性チェック
- **テストケース**:
  - 間隔の上下限値チェック（1分〜60分）
  - Slackトークンの形式チェック
  - チャンネル名の妥当性チェック

##### TC-SC-003: 設定復元
- **目的**: プラグイン再起動時の状態復元
- **テストケース**:
  - 前回設定の正確な復元
  - 自動同期状態の復元
  - 最終同期時刻の復元

### 5. 統合テスト（Integration Tests）

##### TC-IT-001: 自動同期フロー
- **目的**: エンドツーエンドの自動同期確認
- **テストケース**:
  - スケジューラー開始から同期完了まで
  - 複数回の定期同期実行
  - 異なるチャンネルの同期

##### TC-IT-002: UI統合
- **目的**: ステータス表示との連携確認
- **テストケース**:
  - 同期開始時のステータス更新
  - 進捗表示の正確性
  - 完了/エラー時の通知表示

##### TC-IT-003: 永続化連携
- **目的**: データ保存機能との統合確認
- **テストケース**:
  - 取得メッセージのファイル保存
  - 同期履歴の記録
  - メタデータの更新

### 6. パフォーマンステスト

##### TC-PF-001: メモリ使用量
- **目的**: メモリリークの検出
- **テストケース**:
  - 長時間実行でのメモリ増加チェック
  - 停止時のリソース解放確認
  - 大量データ処理時の使用量測定

##### TC-PF-002: CPU使用率
- **目的**: CPU負荷の測定
- **テストケース**:
  - アイドル時のCPU使用率
  - 同期中の負荷測定
  - 複数同期の並行処理負荷

##### TC-PF-003: 応答性
- **目的**: UI応答性の確認
- **テストケース**:
  - 同期中のObsidian操作性
  - コマンド実行の応答時間
  - 設定変更の反映速度

### 7. エッジケーステスト

##### TC-EC-001: 極端な設定値
- **目的**: 境界値での動作確認
- **テストケース**:
  - 最小間隔（1分）での動作
  - 最大間隔（60分）での動作
  - 大量チャンネル設定時の動作

##### TC-EC-002: システム制約
- **目的**: システム制約下での動作
- **テストケース**:
  - ディスク容量不足時の対応
  - ネットワーク断絶時の動作
  - Obsidian強制終了時の状態

##### TC-EC-003: 並行処理
- **目的**: 複数操作の並行実行
- **テストケース**:
  - 自動同期中の手動同期
  - 設定変更中の同期実行
  - プラグイン無効化中の処理

### 8. モックテスト

##### TC-MK-001: タイマーモック
- **目的**: setInterval/clearIntervalの動作確認
- **テストケース**:
  - Jest fakeTimersを使用したタイマー制御
  - 指定時間後の同期実行確認
  - タイマークリア後の停止確認

##### TC-MK-002: API呼び出しモック
- **目的**: SlackAPIClient依存の分離
- **テストケース**:
  - 成功レスポンスのシミュレーション
  - エラーレスポンスのシミュレーション
  - タイムアウトのシミュレーション

##### TC-MK-003: 通知モック
- **目的**: Notice表示機能のテスト
- **テストケース**:
  - 成功通知の表示確認
  - エラー通知の表示確認
  - 通知レベルに応じた表示制御

## テスト実装計画

### Phase 1: 基本機能テスト（TC-AS-001〜010）
- AutoSyncSchedulerクラスの基本メソッド
- 正常系の動作確認
- 実装初期の品質保証

### Phase 2: 競合・エラーテスト（TC-CF-001〜003, TC-EH-001〜004）
- 異常系の動作確認
- 堅牢性の向上
- 実際の運用に近い条件でのテスト

### Phase 3: 統合・パフォーマンステスト（TC-IT-001〜003, TC-PF-001〜003）
- 他コンポーネントとの連携確認
- 性能要件の検証
- エンドツーエンドの動作確認

### Phase 4: エッジケース・モックテスト（TC-EC-001〜003, TC-MK-001〜003）
- 境界値・制約条件のテスト
- 単体テストの完成度向上
- 回帰テストの充実

## 成功基準

- **単体テスト**: 90%以上のコードカバレッジ
- **統合テスト**: 主要ユースケース100%カバー
- **エラーテスト**: 想定される異常系100%カバー
- **パフォーマンステスト**: 要件を満たす性能確認

## テスト環境

- **テストフレームワーク**: Jest
- **モック**: jest.fn(), jest.spyOn()
- **タイマー**: jest.useFakeTimers()
- **アサーション**: Jest matchers + custom matchers

## 継続的テスト

- **実装中**: RED-GREEN-REFACTORサイクル
- **コミット前**: 全テスト実行
- **プルリクエスト**: テストカバレッジ確認
- **リリース前**: 統合・E2Eテスト実行