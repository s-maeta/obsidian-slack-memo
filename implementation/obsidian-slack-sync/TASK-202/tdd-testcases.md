# TASK-202: ファイル保存エンジン - テストケース設計

## テスト戦略
- 単体テスト: 各メソッドの個別機能テスト
- 統合テスト: ファイルI/O を含む実際のファイル操作テスト
- エラーテスト: 異常系とエッジケースの網羅的テスト

## 単体テスト

### 1. FileStorageEngine - コンストラクタ
**TC-FS-001**: 正常なコンストラクタ呼び出し
- **前提条件**: 有効な App と PluginSettings
- **実行**: `new FileStorageEngine(app, settings)`  
- **期待結果**: インスタンスが正常に作成される

### 2. determineSavePath メソッド

**TC-FS-010**: 設定済みチャンネルの保存先決定
- **前提条件**: channelMappings に "C123456" → "/channels/general" が設定済み
- **実行**: `determineSavePath("C123456")`
- **期待結果**: "/channels/general" が返される

**TC-FS-011**: 未設定チャンネルのデフォルトパス使用
- **前提条件**: channelMappings に存在しないチャンネルID、defaultPath = "/slack"
- **実行**: `determineSavePath("C999999")`
- **期待結果**: "/slack" が返される  

**TC-FS-012**: 相対パスの絶対パス変換
- **前提条件**: channelMappings に "C123456" → "channels/general" が設定済み
- **実行**: `determineSavePath("C123456")`
- **期待結果**: 絶対パスに変換された文字列が返される

### 3. generateFileName メソッド

**TC-FS-020**: 基本ファイル名生成
- **前提条件**: fileNameFormat = "{channel}-{date}"、channelName = "general"、date = "2023-12-01"
- **実行**: `generateFileName(message, "general")`
- **期待結果**: "general-2023-12-01.md" が返される

**TC-FS-021**: 全変数を含むファイル名生成  
- **前提条件**: fileNameFormat = "{channel}-{date}-{timestamp}-{user}"
- **実行**: `generateFileName(message, "general")`
- **期待結果**: "general-2023-12-01-1701388800-username.md" 形式が返される

**TC-FS-022**: 無効文字の安全化
- **前提条件**: channelName = "general/test"、fileNameFormat = "{channel}"
- **実行**: `generateFileName(message, "general/test")`  
- **期待結果**: "general_test.md" (スラッシュがアンダースコアに変換)

**TC-FS-023**: 長いファイル名の切り詰め
- **前提条件**: 255文字を超えるファイル名を生成する設定
- **実行**: `generateFileName(message, longChannelName)`
- **期待結果**: 255文字以内に切り詰められたファイル名が返される

### 4. ensureDirectoryExists メソッド  

**TC-FS-030**: 既存ディレクトリの確認
- **前提条件**: 存在するディレクトリパス
- **実行**: `ensureDirectoryExists("/existing/path")`
- **期待結果**: エラーなく完了

**TC-FS-031**: 新規ディレクトリの作成
- **前提条件**: 存在しないが作成可能なディレクトリパス
- **実行**: `ensureDirectoryExists("/new/directory/path")`
- **期待結果**: ディレクトリが作成され、エラーなく完了

**TC-FS-032**: 中間ディレクトリの自動作成
- **前提条件**: 複数階層の未作成ディレクトリパス
- **実行**: `ensureDirectoryExists("/a/b/c/d")`  
- **期待結果**: すべての中間ディレクトリが作成される

### 5. writeFile メソッド

**TC-FS-040**: 基本的なファイル書き込み
- **前提条件**: 書き込み可能なパスと有効なコンテンツ
- **実行**: `writeFile("/path/to/file.md", "content")`
- **期待結果**: ファイルが作成され、コンテンツが書き込まれる

**TC-FS-041**: 既存ファイルの上書き
- **前提条件**: 既存ファイルと新しいコンテンツ
- **実行**: `writeFile("/existing/file.md", "new content")`
- **期待結果**: ファイルが上書きされる

**TC-FS-042**: Unicode文字のファイル書き込み
- **前提条件**: 日本語や絵文字を含むコンテンツ  
- **実行**: `writeFile("/path/to/file.md", "こんにちは 🎉")`
- **期待結果**: 文字化けせずに書き込まれる

### 6. appendToDailyNote メソッド

**TC-FS-050**: 既存デイリーノートへの追記
- **前提条件**: 既存の "2023-12-01.md" ファイル
- **実行**: `appendToDailyNote("new content", "2023-12-01")`
- **期待結果**: ファイル末尾にコンテンツが追記される

**TC-FS-051**: 新規デイリーノートの作成
- **前提条件**: 存在しない日付のデイリーノート  
- **実行**: `appendToDailyNote("content", "2023-12-15")`
- **期待結果**: 新しいデイリーノートファイルが作成される

**TC-FS-052**: 重複追記の防止
- **前提条件**: 同じコンテンツを含むデイリーノート
- **実行**: 同じコンテンツで `appendToDailyNote` を実行
- **期待結果**: 重複した追記が発生しない

## 統合テスト

### 7. saveMessage メソッド - 全体の処理フロー

**TC-FS-060**: 標準的なメッセージ保存処理
- **前提条件**: 有効な FileStorageOptions
- **実行**: `saveMessage(options)`
- **期待結果**: 
  - 適切なパスにファイルが作成される
  - ファイル名フォーマットが適用される  
  - コンテンツが正しく書き込まれる
  - StorageResult が適切に返される

**TC-FS-061**: デイリーノート追記込みの保存処理
- **前提条件**: appendToDailyNote = true の設定
- **実行**: `saveMessage(options)`
- **期待結果**:
  - 通常ファイルが作成される
  - デイリーノートにも追記される
  - 両方の操作が成功する

**TC-FS-062**: 複数メッセージの連続保存
- **前提条件**: 複数の FileStorageOptions
- **実行**: 複数の `saveMessage` を連続実行
- **期待結果**:
  - 各メッセージが個別のファイルとして保存される
  - ファイル名の重複が適切に回避される

### 8. ファイル名重複処理

**TC-FS-070**: 重複ファイル名の自動連番付与
- **前提条件**: 同名ファイルが既に存在する状況
- **実行**: `saveMessage` で同名ファイル生成を実行
- **期待結果**: "filename (1).md", "filename (2).md" のように連番が付与される

**TC-FS-071**: 大量重複時の連番処理
- **前提条件**: 同名ファイルが100個存在
- **実行**: 同名ファイル作成処理
- **期待結果**: "filename (101).md" が作成される

## エラーハンドリングテスト

### 9. パス・権限エラー

**TC-FS-080**: 無効な保存先パス
- **前提条件**: 存在しないドライブのパス (Windows) または不正パス
- **実行**: `determineSavePath` または `saveMessage`
- **期待結果**: 適切なエラーが返される

**TC-FS-081**: 書き込み権限なしディレクトリ
- **前提条件**: 読み取り専用ディレクトリの指定
- **実行**: `writeFile` または `saveMessage`
- **期待結果**: PermissionError が返される

**TC-FS-082**: ディスク容量不足
- **前提条件**: ディスク容量不足の環境（モック）
- **実行**: `writeFile` で大きなファイル書き込み
- **期待結果**: DiskFullError が返される

### 10. ファイル操作エラー

**TC-FS-090**: ファイルロック中の書き込み
- **前提条件**: 他のプロセスでロックされたファイル
- **実行**: `writeFile` でロックファイルへの書き込み
- **期待結果**: FileLockError が返される

**TC-FS-091**: 不正なファイル名
- **前提条件**: OS で禁止された文字を含むファイル名
- **実行**: `generateFileName` で不正文字を含む設定
- **期待結果**: 安全化された名前が返される

**TC-FS-092**: 長すぎるパス
- **前提条件**: OS の制限を超える長さのパス
- **実行**: `saveMessage` で長大なパス
- **期待結果**: PathTooLongError が返される

### 11. 設定エラー

**TC-FS-100**: 未設定のデフォルトパス
- **前提条件**: defaultPath が設定されていない
- **実行**: 未設定チャンネルでの `determineSavePath`
- **期待結果**: 適切なデフォルト動作またはエラー

**TC-FS-101**: 不正なファイル名フォーマット
- **前提条件**: 無効な変数を含む fileNameFormat
- **実行**: `generateFileName` の実行
- **期待結果**: フォーマットエラーまたは安全な代替フォーマット

### 12. 並行処理テスト

**TC-FS-110**: 同時ファイル書き込み
- **前提条件**: 複数スレッドからの同時書き込み
- **実行**: 並行 `saveMessage` 実行
- **期待結果**: データの破損なく、すべてのファイルが正常に作成される

**TC-FS-111**: 同時ディレクトリ作成
- **前提条件**: 複数スレッドから同じディレクトリの作成要求
- **実行**: 並行 `ensureDirectoryExists` 実行
- **期待結果**:競合状態なく、ディレクトリが作成される

## パフォーマンステスト

### 13. 大量データ処理

**TC-FS-120**: 大量メッセージの連続保存
- **前提条件**: 1000件のメッセージデータ
- **実行**: 1000回の `saveMessage` 実行
- **期待結果**: 合理的な時間内（10秒以内）ですべて完了

**TC-FS-121**: 大きなファイルサイズの処理
- **前提条件**: 10MBのコンテンツを含むメッセージ
- **実行**: `saveMessage` の実行
- **期待結果**: メモリ不足なく正常に保存される

## エッジケーステスト  

### 14. 境界値・特殊ケース

**TC-FS-130**: 空のコンテンツ
- **前提条件**: content = "" の FileStorageOptions
- **実行**: `saveMessage` の実行
- **期待結果**: 空ファイルが作成される

**TC-FS-131**: null/undefined 値の処理
- **前提条件**: 各種パラメータに null または undefined
- **実行**: 各メソッドの実行
- **期待結果**: 適切なエラーハンドリングまたはデフォルト値使用

**TC-FS-132**: 特殊文字を含むチャンネル名
- **前提条件**: Unicode、記号、制御文字を含むチャンネル名
- **実行**: `generateFileName` の実行
- **期待結果**: ファイルシステムで安全な名前に変換される

## テスト環境設定

### モックオブジェクト
- **Obsidian App**: ファイル操作 API のモック
- **FileSystem**: Node.js fs モジュールのモック  
- **PluginSettings**: テスト用設定オブジェクト

### テストデータ
- **SlackMessage**: 様々なパターンのメッセージオブジェクト
- **FileStorageOptions**: 各種設定パターン
- **PluginSettings**: エラーケースを含む設定パターン

### テスト実行順序
1. 単体テスト (TC-FS-001 ～ TC-FS-052)
2. 統合テスト (TC-FS-060 ～ TC-FS-071)  
3. エラーハンドリングテスト (TC-FS-080 ～ TC-FS-101)
4. 並行処理テスト (TC-FS-110 ～ TC-FS-111)
5. パフォーマンステスト (TC-FS-120 ～ TC-FS-121)
6. エッジケーステスト (TC-FS-130 ～ TC-FS-132)

## カバレッジ目標
- **ラインカバレッジ**: 95%以上
- **ブランチカバレッジ**: 90%以上  
- **関数カバレッジ**: 100%