# TASK-302: 同期状態表示UI - TDD要件定義

## 実装日時
2025-01-11

## 要件概要
Slack同期プロセスの視覚的フィードバックを提供するUI実装。ユーザーが同期の進行状況、成功・失敗、履歴を直感的に把握できるインターフェースを構築する。

## 機能要件

### F1. ステータスバー統合
**要件ID**: REQ-202-01
**優先度**: 高

#### 機能詳細
- Obsidianステータスバーに同期状態アイコンを表示
- 同期状態に応じたアイコン・色の変更
- クリックで詳細モーダル表示

#### 状態表示仕様
```typescript
enum SyncStatus {
  IDLE = 'idle',           // アイドル状態 - グレー
  SYNCING = 'syncing',     // 同期中 - 青色アニメーション
  SUCCESS = 'success',     // 成功 - 緑色
  ERROR = 'error',         // エラー - 赤色
  WARNING = 'warning'      // 警告 - オレンジ色
}
```

#### 表示要素
- **アイコン**: 同期状態を表す視覚的インジケーター
- **テキスト**: 状態の文字説明（ホバー時）
- **最終同期時刻**: 最後に成功した同期の時刻

### F2. 同期進捗モーダル
**要件ID**: REQ-202-02
**優先度**: 高

#### 機能詳細
- 詳細な同期プロセス情報を表示
- リアルタイム進捗更新
- 同期キャンセル機能

#### モーダル構成要素
1. **ヘッダー**
   - 現在の同期状態タイトル
   - 進行中/完了/エラーの状態表示

2. **プログレスセクション**
   - 全体進捗バー（0-100%）
   - 現在処理中のチャンネル表示
   - 処理済み/総数の数値表示

3. **ログセクション**
   - 同期プロセスの詳細ログ
   - エラーメッセージの表示
   - タイムスタンプ付きの処理記録

4. **アクションボタン**
   - キャンセル（同期中のみ）
   - 閉じる
   - 再試行（エラー時のみ）

### F3. エラー通知システム
**要件ID**: REQ-305-01
**優先度**: 高

#### 通知タイプ
1. **トースト通知**
   - 同期開始/完了の通知
   - エラー発生時の警告
   - 自動消去（5秒後）

2. **エラーダイアログ**
   - 重大なエラー時の詳細表示
   - ユーザーアクション要求
   - 手動での閉じる操作

#### 通知メッセージ例
```typescript
const NOTIFICATION_MESSAGES = {
  SYNC_STARTED: 'Slack同期を開始しました',
  SYNC_COMPLETED: (count: number) => `${count}件のメッセージを同期しました`,
  SYNC_ERROR: (error: string) => `同期エラー: ${error}`,
  SYNC_CANCELLED: '同期がキャンセルされました',
  NO_NEW_MESSAGES: '新しいメッセージはありません'
};
```

### F4. 同期履歴ビュー
**要件ID**: REQ-305-02
**優先度**: 中

#### 履歴表示機能
- 過去の同期実行記録表示
- 成功/失敗の状態表示
- 同期されたメッセージ数
- 実行時間の記録

#### 履歴データ構造
```typescript
interface SyncHistoryItem {
  id: string;
  timestamp: Date;
  status: SyncStatus;
  channelsProcessed: number;
  messagesCount: number;
  duration: number; // milliseconds
  error?: string;
}
```

#### 履歴管理
- 最新100件の履歴保持
- 古い履歴の自動削除
- 履歴データの永続化

## 非機能要件

### NF1. パフォーマンス要件
- **応答性**: UI更新は50ms以内
- **メモリ効率**: 履歴データは最大10MBに制限
- **バッテリー効率**: アニメーションのCPU使用最適化

### NF2. ユーザビリティ要件
- **直感性**: 一目で同期状態が分かるデザイン
- **一貫性**: Obsidianテーマとの視覚的調和
- **アクセシビリティ**: カラーブラインド対応、キーボード操作

### NF3. 信頼性要件
- **耐障害性**: ネットワークエラー時の適切な処理
- **状態管理**: 同期状態の正確な追跡
- **データ整合性**: 履歴データの破損防止

## UI/UX設計仕様

### U1. ステータスバーアイテム
```
┌─────────────────┐
│ 🔄 同期中... │ ← アニメーション付き
└─────────────────┘

┌─────────────────┐
│ ✅ 同期完了 │ ← 成功状態
└─────────────────┘

┌─────────────────┐
│ ❌ 同期エラー │ ← エラー状態
└─────────────────┘
```

### U2. 進捗モーダルレイアウト
```
┌──────────────────────────────────┐
│ Slack同期状態               [×] │
├──────────────────────────────────┤
│ 進捗: ████████░░ 80%             │
│ 処理中: #general (3/5)           │
├──────────────────────────────────┤
│ ログ:                           │
│ 10:30:15 - #general開始          │
│ 10:30:16 - 25件のメッセージ取得    │
│ 10:30:17 - #random開始           │
├──────────────────────────────────┤
│        [キャンセル] [閉じる]      │
└──────────────────────────────────┘
```

### U3. トースト通知
```
┌─────────────────────────────────┐
│ ✅ Slack同期完了                │
│ 42件のメッセージを同期しました    │
└─────────────────────────────────┘
```

## 技術仕様

### T1. 状態管理設計
```typescript
interface SyncStatusManager {
  // 現在の同期状態
  currentStatus: SyncStatus;
  
  // 進捗情報
  progress: {
    current: number;
    total: number;
    percentage: number;
    currentChannel?: string;
  };
  
  // エラー情報
  lastError?: {
    message: string;
    timestamp: Date;
    code?: string;
  };
  
  // 履歴管理
  history: SyncHistoryItem[];
  
  // 通知管理
  notifications: NotificationQueue;
}
```

### T2. イベント駆動アーキテクチャ
```typescript
// 同期イベントの定義
type SyncEvent = 
  | { type: 'SYNC_START'; payload: { channels: string[] } }
  | { type: 'SYNC_PROGRESS'; payload: { current: number; total: number } }
  | { type: 'SYNC_SUCCESS'; payload: { messageCount: number } }
  | { type: 'SYNC_ERROR'; payload: { error: Error } }
  | { type: 'SYNC_CANCEL'; payload: {} };

// UIコンポーネントはイベントをリッスンして状態更新
class SyncStatusUI {
  onSyncEvent(event: SyncEvent): void;
  updateDisplay(): void;
  showNotification(message: string, type: NotificationType): void;
}
```

### T3. Obsidian統合
- **StatusBarItem**: ステータスバー統合
- **Modal**: 詳細表示用モーダル
- **Notice**: トースト通知
- **Component**: ライフサイクル管理

## データ永続化

### D1. 同期履歴保存
- **保存場所**: プラグインデータディレクトリ
- **ファイル名**: `sync-history.json`
- **最大サイズ**: 10MB
- **データ形式**: JSON

### D2. 状態復元
- Obsidian起動時の状態復元
- 未完了同期の検出と処理
- 履歴データの整合性確認

## セキュリティ考慮事項

### S1. エラー情報の保護
- 機密情報を含むエラーメッセージの除外
- ログファイルでの個人情報保護
- トークン等の認証情報の非表示

### S2. 履歴データの暗号化
- 履歴データの暗号化保存（オプション）
- 第三者によるアクセス防止

## テスタビリティ要件

### Test1. 単体テスト
- 状態遷移ロジックのテスト
- UI更新ロジックのテスト
- エラーハンドリングのテスト

### Test2. 統合テスト
- 同期プロセスとUIの連携テスト
- 永続化機能のテスト
- パフォーマンステスト

### Test3. E2Eテスト
- ユーザーシナリオの完全テスト
- エラーからの回復テスト
- 長時間実行時のメモリリークテスト

## 実装優先順位

### Phase 1 (必須機能)
1. ステータスバーアイテム基本実装
2. 基本状態表示（アイドル/同期中/完了/エラー）
3. 簡単なトースト通知

### Phase 2 (コア機能)
1. 進捗モーダル実装
2. リアルタイム進捗更新
3. 同期キャンセル機能
4. エラー詳細表示

### Phase 3 (拡張機能)
1. 同期履歴ビュー
2. 詳細ログ表示
3. 履歴の永続化
4. パフォーマンス最適化

## 受け入れ基準

### AC1. 基本機能
- [ ] ステータスバーに同期状態が表示される
- [ ] 同期開始/完了時にトースト通知が表示される
- [ ] エラー発生時に分かりやすいメッセージが表示される

### AC2. 進捗表示
- [ ] 同期進捗がリアルタイムで更新される
- [ ] 現在処理中のチャンネルが表示される
- [ ] 進捗パーセンテージが正確に計算される

### AC3. 操作性
- [ ] 同期をキャンセルできる
- [ ] エラー状態から再試行できる
- [ ] 履歴から過去の同期結果を確認できる

### AC4. 統合性
- [ ] Obsidianテーマに適合したデザイン
- [ ] プラグイン無効化時の適切なクリーンアップ
- [ ] 他のプラグインとの競合がない

## 実装制約

### C1. 技術制約
- Obsidian API v1.0.0以降での実装
- TypeScript 4.0以降の使用
- モバイル版対応（基本機能のみ）

### C2. パフォーマンス制約
- UI更新頻度: 最大10回/秒
- メモリ使用量: 追加50MB以下
- ストレージ使用量: 履歴データ最大10MB

### C3. ユーザビリティ制約
- 5秒以内の操作応答
- 初回表示1秒以内
- 最小限の画面占有領域

この要件定義に基づいて、次のフェーズでテストケースの設計を行います。